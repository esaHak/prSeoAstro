---
/**
 * Locale-specific Homepage
 * Lists all top-level categories in the current locale
 * Uses the warm, minimal design system with card grid layout
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import CategoryCard from '../../components/CategoryCard.astro';
import OrganizationSchema from '../../components/schemas/OrganizationSchema.astro';
import { DB } from '../../utils/db';
import { resolveOgImage, loadImageById, withAbsoluteUrl } from '../../utils/images';
import type { ImageWithUrl } from '../../utils/images/types';
import {
  supportedLocales,
  getLocalizedField,
  getAvailableLocalesForEntity,
  buildLocalizedUrl,
  type Locale
} from '../../utils/i18n';

export function getStaticPaths() {
  return supportedLocales.map(locale => ({
    params: { locale },
    props: { locale }
  }));
}

const { locale } = Astro.props as { locale: Locale };
const base = import.meta.env.BASE_URL;
const siteBase = Astro.site?.toString() || 'https://prseoastro.pages.dev';
const categories = DB.getAllCategories();

// Resolve OG image for homepage (uses default)
const ogImage = resolveOgImage({}, undefined, siteBase);

// Build hreflang links for language switcher (including x-default)
const normalizedSiteBase = siteBase.replace(/\/$/, '');
const hreflangLinks = [
  ...supportedLocales.map(loc => ({
    hreflang: loc,
    href: `${normalizedSiteBase}/${loc}/`
  })),
  {
    hreflang: 'x-default',
    href: `${normalizedSiteBase}/en/`
  }
];

// Build alternate URLs for language switcher
const alternateUrls = supportedLocales.map(loc => ({
  locale: loc,
  url: `/${loc}/`
}));

// Pre-compute category data with localized fields and images
interface CategoryItem {
  title: string;
  description: string;
  url: string;
  image: ImageWithUrl | null;
}

const categoryItems: CategoryItem[] = categories
  .filter(category => getAvailableLocalesForEntity(category).includes(locale))
  .map((category) => {
    // Try to get hero or OG image for the category
    let image: ImageWithUrl | null = null;
    if (category.heroImageId) {
      const img = loadImageById(category.heroImageId);
      if (img) image = withAbsoluteUrl(img, siteBase);
    } else if (category.ogImageId) {
      const img = loadImageById(category.ogImageId);
      if (img) image = withAbsoluteUrl(img, siteBase);
    }

    return {
      title: getLocalizedField<string>(category, 'title', locale) || category.id,
      description: getLocalizedField<string>(category, 'description', locale) || '',
      url: buildLocalizedUrl(locale, category, base),
      image
    };
  });

// Localized page content
const pageContent = {
  en: {
    title: 'Programmatic SEO Glossary',
    description: 'A comprehensive resource for programmatic SEO strategies, techniques, and best practices',
    intro: 'Welcome to our comprehensive programmatic SEO glossary. Explore in-depth guides on various topics, strategies, and best practices to help you succeed.',
    browseTitle: 'Explore Topics',
    browseIntro: 'Select a topic below to discover in-depth information and expert recommendations.',
    aboutTitle: 'About This Resource',
    aboutText: 'This glossary is designed to provide you with comprehensive, well-researched information on programmatic SEO. Each page is carefully structured to help you find exactly what you need, with clear navigation and related content suggestions.'
  },
  fi: {
    title: 'Ohjelmallisen SEO:n sanasto',
    description: 'Kattava resurssi ohjelmalliseen hakukoneoptimointiin',
    intro: 'Tervetuloa kattavaan ohjelmallisen SEO:n sanastoomme. Tutustu syvällisiin oppaisiin eri aiheista, strategioista ja parhaista käytännöistä menestyksesi tueksi.',
    browseTitle: 'Selaa aiheita',
    browseIntro: 'Valitse aihe alta löytääksesi syvällistä tietoa ja asiantuntijasuosituksia.',
    aboutTitle: 'Tietoa resurssista',
    aboutText: 'Tämä sanasto on suunniteltu tarjoamaan kattavaa, hyvin tutkittua tietoa ohjelmallisesta hakukoneoptimoinnista. Jokainen sivu on huolellisesti jäsennelty auttamaan sinua löytämään juuri sen, mitä tarvitset, selkeällä navigoinnilla ja aiheeseen liittyvillä sisältösuosituksilla.'
  }
};

const content = pageContent[locale] || pageContent.en;
---

<BaseLayout
  title={content.title}
  description={content.description}
  ogImage={ogImage}
  locale={locale}
  hreflangLinks={hreflangLinks}
  alternateUrls={alternateUrls}
>
  <OrganizationSchema siteBase={siteBase} />

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero__inner">
      <h1 class="hero__title">{content.title}</h1>
      <p class="hero__description">{content.intro}</p>
    </div>
  </section>

  <!-- Categories Grid -->
  <section class="card-section">
    <header class="card-section__header">
      <h2 class="card-section__title">{content.browseTitle}</h2>
      <p class="card-section__description">{content.browseIntro}</p>
    </header>
    <div class="card-grid">
      {categoryItems.map((item) => (
        <CategoryCard
          title={item.title}
          description={item.description}
          url={item.url}
          image={item.image}
        />
      ))}
    </div>
  </section>

  <!-- About Section -->
  <article class="content-body">
    <section>
      <h2>{content.aboutTitle}</h2>
      <p>{content.aboutText}</p>
    </section>
  </article>
</BaseLayout>
