---
// Dynamic page template using relational database structure
// Generates pages for categories and subcategories with cross-references

import BaseLayout from '../../layouts/BaseLayout.astro';
import { DB, type Category, type Subcategory } from '../../utils/db';

// Generate all static paths from relational database
export function getStaticPaths() {
  const paths = [];

  // Add all category pages
  for (const category of DB.getAllCategories()) {
    paths.push({
      params: { slug: category.slug },
      props: {
        type: 'category' as const,
        data: category
      }
    });
  }

  // Add all subcategory pages
  for (const subcategory of DB.getAllSubcategories()) {
    const fullPath = DB.getFullPath(subcategory);
    paths.push({
      params: { slug: fullPath },
      props: {
        type: 'subcategory' as const,
        data: subcategory
      }
    });
  }

  return paths;
}

const { type, data } = Astro.props;
const base = import.meta.env.BASE_URL;

// Build page-specific data based on type
let title: string;
let description: string;
let breadcrumbs: Array<{ title: string; url: string }>;
let childItems: Array<{ title: string; description: string; url: string }> = [];
let relatedCategories: Category[] = [];

if (type === 'category') {
  const category = data as Category;
  title = category.title;
  description = category.description;
  breadcrumbs = [{ title: category.title, url: `${base}${category.slug}/` }];

  // Get subcategories for this category
  const subcategories = DB.getSubcategoriesByCategory(category.id);
  childItems = subcategories.map(sub => ({
    title: sub.title,
    description: sub.description,
    url: `${base}${DB.getFullPath(sub)}/`
  }));
} else {
  const subcategory = data as Subcategory;
  title = subcategory.title;
  description = subcategory.description;

  // Get breadcrumbs from database
  const crumbs = DB.getBreadcrumbs(subcategory);
  breadcrumbs = crumbs.map(crumb => ({
    title: crumb.title,
    url: `${base}${crumb.path}/`
  }));

  // Get child subcategories
  const children = DB.getChildSubcategories(subcategory);
  childItems = children.map(child => ({
    title: child.title,
    description: child.description,
    url: `${base}${DB.getFullPath(child)}/`
  }));

  // Get related categories
  relatedCategories = DB.getRelatedCategories(subcategory);
}
---

<BaseLayout title={title} description={description}>
  <nav>
    <a href={base}>Home</a>
    {breadcrumbs.slice(0, -1).map((crumb) => (
      <>
        {' → '}
        <a href={crumb.url}>{crumb.title}</a>
      </>
    ))}
  </nav>

  <h1>{title}</h1>
  <p style="font-size: 1.1rem; line-height: 1.6;">{description}</p>

  <section style="margin: 2rem 0;">
    <h2>Overview</h2>
    <p>This page covers everything you need to know about {title.toLowerCase()}. We've compiled comprehensive information, best practices, and recommendations to help you make informed decisions.</p>

    <p>Whether you're just getting started or looking to optimize your existing setup, you'll find valuable insights and detailed guidance throughout this resource.</p>
  </section>

  {childItems.length > 0 && (
    <section style="margin: 2rem 0;">
      <h2>Explore {title} Topics</h2>
      <p style="margin-bottom: 1.5rem;">Dive deeper into specific aspects of {title.toLowerCase()} with our detailed guides below:</p>

      <div>
        {childItems.map((item) => (
          <article style="margin-bottom: 2rem; padding: 1.5rem; background: #f9f9f9; border-left: 4px solid #333;">
            <h3 style="margin-top: 0;">
              <a href={item.url} style="text-decoration: none; color: #0066cc;">
                {item.title}
              </a>
            </h3>
            <p style="margin: 0.75rem 0 0 0; color: #555; line-height: 1.6;">
              {item.description}
            </p>
            <p style="margin: 0.75rem 0 0 0;">
              <a href={item.url} style="color: #0066cc;">
                Learn more about {item.title.toLowerCase()} →
              </a>
            </p>
          </article>
        ))}
      </div>
    </section>
  )}

  {relatedCategories.length > 0 && (
    <section style="margin: 2rem 0; padding: 1.5rem; background: #e8f4f8; border-radius: 8px;">
      <h2>Related Topics</h2>
      <p style="margin-bottom: 1rem;">You might also be interested in these related categories:</p>
      <ul style="line-height: 1.8;">
        {relatedCategories.map((cat) => (
          <li>
            <a href={`${base}${cat.slug}/`} style="color: #0066cc;">
              {cat.title}
            </a>
            {' - '}
            {cat.description}
          </li>
        ))}
      </ul>
    </section>
  )}

  <section style="margin: 2rem 0;">
    <h2>Key Features</h2>
    <ul style="line-height: 1.8;">
      <li>Comprehensive coverage of {title.toLowerCase()}</li>
      <li>Up-to-date information and best practices</li>
      <li>Practical examples and use cases</li>
      <li>Expert recommendations and insights</li>
    </ul>
  </section>

  <section style="margin: 2rem 0;">
    <h2>Why Choose {title}?</h2>
    <p>When evaluating options for {title.toLowerCase()}, it's important to consider various factors including functionality, scalability, ease of use, and long-term value. This guide helps you understand these considerations in depth.</p>

    <p>Our research-backed approach ensures you have access to accurate, reliable information that can guide your decision-making process effectively.</p>
  </section>

  <hr />
  {breadcrumbs.length > 1 ? (
    <a href={breadcrumbs[breadcrumbs.length - 2].url}>
      ← Back to {breadcrumbs[breadcrumbs.length - 2].title}
    </a>
  ) : (
    <a href={base}>← Back to Home</a>
  )}
</BaseLayout>
