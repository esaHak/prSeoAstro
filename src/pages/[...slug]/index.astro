---
// Dynamic page template using relational database structure
// Generates pages for categories and subcategories with cross-references

import BaseLayout from '../../layouts/BaseLayout.astro';
import HeroImage from '../../components/HeroImage.astro';
import ContentRenderer from '../../components/ContentRenderer.astro';
import { DB, type Category, type Subcategory } from '../../utils/db';
import { addInternalLinks, defaultConfig } from '../../utils/internalLinking';
import type { PageContext } from '../../utils/internalLinking/targetResolver';
import { resolveOgImage, resolveHeroImage } from '../../utils/images';
import type { ContentItem } from '../../utils/videos/types';

// Generate all static paths from relational database
export function getStaticPaths() {
  const paths = [];

  // Add all category pages
  for (const category of DB.getAllCategories()) {
    paths.push({
      params: { slug: category.slug },
      props: {
        type: 'category' as const,
        data: category
      }
    });
  }

  // Add all subcategory pages
  for (const subcategory of DB.getAllSubcategories()) {
    const fullPath = DB.getFullPath(subcategory);
    paths.push({
      params: { slug: fullPath },
      props: {
        type: 'subcategory' as const,
        data: subcategory
      }
    });
  }

  return paths;
}

const { type, data } = Astro.props;
const base = import.meta.env.BASE_URL;
const siteBase = Astro.site?.toString() || 'https://prseoastro.pages.dev';

// Build page-specific data based on type
let title: string;
let description: string;
let breadcrumbs: Array<{ title: string; url: string }>;
let childItems: Array<{ title: string; description: string; url: string }> = [];
let relatedCategories: Category[] = [];
let parentCategory: Category | undefined;

if (type === 'category') {
  const category = data as Category;
  title = category.title;
  description = category.description;
  breadcrumbs = [{ title: category.title, url: `${base}${category.slug}/` }];

  // Get subcategories for this category
  const subcategories = DB.getSubcategoriesByCategory(category.id);
  childItems = subcategories.map(sub => ({
    title: sub.title,
    description: sub.description,
    url: `${base}${DB.getFullPath(sub)}/`
  }));
} else {
  const subcategory = data as Subcategory;
  title = subcategory.title;
  description = subcategory.description;

  // Get breadcrumbs from database
  const crumbs = DB.getBreadcrumbs(subcategory);
  breadcrumbs = crumbs.map(crumb => ({
    title: crumb.title,
    url: `${base}${crumb.path}/`
  }));

  // Get child subcategories
  const children = DB.getChildSubcategories(subcategory);
  childItems = children.map(child => ({
    title: child.title,
    description: child.description,
    url: `${base}${DB.getFullPath(child)}/`
  }));

  // Get related categories
  relatedCategories = DB.getRelatedCategories(subcategory);

  // Get parent category for image fallback
  parentCategory = DB.getCategoryById(subcategory.parentCategoryId);
}

// Resolve images with fallback chain
const ogImage = resolveOgImage(data, parentCategory, siteBase);
const heroImage = resolveHeroImage(data, siteBase);

// Build page context for internal linking
const linkContext: PageContext = {
  type,
  entity: data,
  id: data.id,
  slug: data.slug,
};

// Helper function to process HTML with internal linking
function processWithLinks(htmlContent: string): string {
  const result = addInternalLinks(htmlContent, linkContext, defaultConfig);
  return result.html;
}

// Get content from database or use fallback templates
const content = data.content || {};

// Overview content - now supports ContentItem[] (strings or video blocks)
const overviewItems: ContentItem[] = content.overview || [
  "This comprehensive guide covers everything you need to know about ${title.toLowerCase()}, including key features, implementation strategies, and best practices for success. We've compiled detailed information and expert recommendations to help you make informed decisions about your tools and workflows.",
  "Whether you're just getting started with your first implementation or looking to optimize your existing setup, you'll find valuable insights throughout this resource. Our research-backed approach ensures you have access to accurate, reliable information that can guide your decision-making process effectively, helping you choose the right solutions for your specific needs and business objectives."
];

// Key Benefits content - still rendered as list items (does not support video blocks)
const keyBenefitsHtml = content.keyBenefits
  ? content.keyBenefits.filter(item => typeof item === 'string').map(b => `<li>${b}</li>`).join('\n')
  : `<li>Comprehensive coverage of ${title.toLowerCase()}</li>
     <li>Up-to-date information and best practices</li>
     <li>Practical examples and use cases</li>
     <li>Expert recommendations and insights</li>`;

// Why Choose content - now supports ContentItem[] (strings or video blocks)
const whyChooseItems: ContentItem[] = content.whyChoose || [
  "When evaluating options for ${title.toLowerCase()}, it's important to consider various factors including functionality, scalability, ease of use, and long-term value. The right choice will integrate seamlessly with your existing tools and processes, whether you're using project management software, email marketing platforms, or other business systems. Strong integration capabilities ensure your tools work together harmoniously.",
  "Modern businesses benefit from connected ecosystems where CRM software, project management tools, and email marketing platforms share data and insights. This integration enables better decision-making, improved team collaboration, and more effective customer engagement strategies across all touchpoints."
];
---

<BaseLayout title={title} description={description} ogImage={ogImage}>
  <nav>
    <a href={base}>Home</a>
    {breadcrumbs.slice(0, -1).map((crumb) => (
      <>
        {' → '}
        <a href={crumb.url}>{crumb.title}</a>
      </>
    ))}
  </nav>

  <h1>{title}</h1>
  <p style="font-size: 1.1rem; line-height: 1.6;">{description}</p>

  {heroImage && <HeroImage image={heroImage} />}

  <section style="margin: 2rem 0;">
    <h2>Overview</h2>
    <ContentRenderer items={overviewItems} linkContext={linkContext} />
  </section>

  {childItems.length > 0 && (
    <section style="margin: 2rem 0;">
      <h2>Explore {title} Topics</h2>
      <p style="margin-bottom: 1.5rem;">Dive deeper into specific aspects of {title.toLowerCase()} with our detailed guides below:</p>

      <div>
        {childItems.map((item) => (
          <article style="margin-bottom: 2rem; padding: 1.5rem; background: #f9f9f9; border-left: 4px solid #333;">
            <h3 style="margin-top: 0;">
              <a href={item.url} style="text-decoration: none; color: #0066cc;">
                {item.title}
              </a>
            </h3>
            <p style="margin: 0.75rem 0 0 0; color: #555; line-height: 1.6;">
              {item.description}
            </p>
            <p style="margin: 0.75rem 0 0 0;">
              <a href={item.url} style="color: #0066cc;">
                Learn more about {item.title.toLowerCase()} →
              </a>
            </p>
          </article>
        ))}
      </div>
    </section>
  )}

  {relatedCategories.length > 0 && (
    <section style="margin: 2rem 0; padding: 1.5rem; background: #e8f4f8; border-radius: 8px;">
      <h2>Related Topics</h2>
      <p style="margin-bottom: 1rem;">You might also be interested in these related categories:</p>
      <ul style="line-height: 1.8;">
        {relatedCategories.map((cat) => (
          <li>
            <a href={`${base}${cat.slug}/`} style="color: #0066cc;">
              {cat.title}
            </a>
            {' - '}
            {cat.description}
          </li>
        ))}
      </ul>
    </section>
  )}

  <section style="margin: 2rem 0;">
    <h2>Key Benefits</h2>
    <ul style="line-height: 1.8;">
      <Fragment set:html={keyBenefitsHtml} />
    </ul>
  </section>

  <section style="margin: 2rem 0;">
    <h2>Why Choose {title}?</h2>
    <ContentRenderer items={whyChooseItems} linkContext={linkContext} />
  </section>

  <hr />
  {breadcrumbs.length > 1 ? (
    <a href={breadcrumbs[breadcrumbs.length - 2].url}>
      ← Back to {breadcrumbs[breadcrumbs.length - 2].title}
    </a>
  ) : (
    <a href={base}>← Back to Home</a>
  )}
</BaseLayout>
