---
// Dynamic page template using relational database structure
// Generates pages for categories and subcategories with cross-references
// Now supports multi-locale content with optional per-page variants

import BaseLayout from '../../layouts/BaseLayout.astro';
import HeroImage from '../../components/HeroImage.astro';
import ContentRenderer from '../../components/ContentRenderer.astro';
import { DB, type Category, type Subcategory } from '../../utils/db';
import type { PageContext } from '../../utils/internalLinking/targetResolver';
import { resolveOgImage, resolveHeroImage } from '../../utils/images';
import type { ContentItem } from '../../utils/videos/types';
import {
  getAvailableLocalesForEntity,
  getLocalizedField,
  buildLocalizedUrl,
  buildHreflangLinks,
  getLocalizedContentSection
} from '../../utils/i18n';

// Generate all static paths from relational database
// Now includes locale-specific routes
export function getStaticPaths() {
  const paths = [];

  // Add all category pages (with locale variants)
  for (const category of DB.getAllCategories()) {
    const availableLocales = getAvailableLocalesForEntity(category);

    for (const locale of availableLocales) {
      paths.push({
        params: { slug: `${locale}/${category.slug}` },
        props: {
          type: 'category' as const,
          data: category,
          locale
        }
      });
    }
  }

  // Add all subcategory pages (with locale variants)
  for (const subcategory of DB.getAllSubcategories()) {
    const availableLocales = getAvailableLocalesForEntity(subcategory);
    const fullPath = DB.getFullPath(subcategory);

    for (const locale of availableLocales) {
      paths.push({
        params: { slug: `${locale}/${fullPath}` },
        props: {
          type: 'subcategory' as const,
          data: subcategory,
          locale
        }
      });
    }
  }

  return paths;
}

const { type, data, locale } = Astro.props;
const base = import.meta.env.BASE_URL;
const siteBase = Astro.site?.toString() || 'https://prseoastro.pages.dev';

// Get available locales and build alternate URLs
const availableLocales = getAvailableLocalesForEntity(data);
const hreflangLinks = buildHreflangLinks(data, siteBase, base);

// Build alternate URLs for language switcher
const alternateUrls = availableLocales.map(loc => ({
  locale: loc,
  url: buildLocalizedUrl(loc, data, base)
}));

// Get localized fields
const title = getLocalizedField<string>(data, 'title', locale) || data.id;
const description = getLocalizedField<string>(data, 'description', locale) || '';

// Build page-specific data based on type
let breadcrumbs: Array<{ title: string; url: string }>;
let childItems: Array<{ title: string; description: string; url: string }> = [];
let relatedCategories: Category[] = [];
let parentCategory: Category | undefined;

if (type === 'category') {
  const category = data as Category;
  breadcrumbs = [{ title, url: `${base}/${locale}/${category.slug}/` }];

  // Get subcategories for this category (only if they have the current locale)
  const subcategories = DB.getSubcategoriesByCategory(category.id);
  childItems = subcategories
    .filter(sub => getAvailableLocalesForEntity(sub).includes(locale))
    .map(sub => ({
      title: getLocalizedField<string>(sub, 'title', locale) || sub.id,
      description: getLocalizedField<string>(sub, 'description', locale) || '',
      url: buildLocalizedUrl(locale, sub, base)
    }));
} else {
  const subcategory = data as Subcategory;

  // Get breadcrumbs from database (localized)
  const crumbs = DB.getBreadcrumbs(subcategory);
  breadcrumbs = crumbs.map(crumb => {
    const entity = DB.getCategoryById(crumb.slug) || DB.getSubcategoryById(crumb.slug);
    const localizedTitle = entity
      ? getLocalizedField<string>(entity, 'title', locale) || (typeof crumb.title === 'string' ? crumb.title : '')
      : (typeof crumb.title === 'string' ? crumb.title : '');

    return {
      title: localizedTitle,
      url: `${base}/${locale}/${crumb.path}/`
    };
  });

  // Get child subcategories (only if they have the current locale)
  const children = DB.getChildSubcategories(subcategory);
  childItems = children
    .filter(child => getAvailableLocalesForEntity(child).includes(locale))
    .map(child => ({
      title: getLocalizedField<string>(child, 'title', locale) || child.id,
      description: getLocalizedField<string>(child, 'description', locale) || '',
      url: buildLocalizedUrl(locale, child, base)
    }));

  // Get related categories (only if they have the current locale)
  relatedCategories = DB.getRelatedCategories(subcategory)
    .filter(cat => getAvailableLocalesForEntity(cat).includes(locale));

  // Get parent category for image fallback
  parentCategory = DB.getCategoryById(subcategory.parentCategoryId);
}

// Pre-compute related category items for rendering
const relatedItems = relatedCategories.map(cat => ({
  title: getLocalizedField<string>(cat, 'title', locale) || cat.id,
  description: getLocalizedField<string>(cat, 'description', locale) || '',
  url: buildLocalizedUrl(locale, cat, base)
}));

// Resolve images with fallback chain
const ogImage = resolveOgImage(data, parentCategory, siteBase);
const heroImage = resolveHeroImage(data, siteBase);

// Build page context for internal linking (now includes locale)
const linkContext: PageContext = {
  type,
  entity: data,
  id: data.id,
  slug: data.slug,
  locale
};

// Get localized content from database or use fallback templates
const localizedContent = getLocalizedContentSection(data, locale);
const content = localizedContent || {};

// Overview content - now supports ContentItem[] (strings or video blocks)
const overviewItems: ContentItem[] = content.overview || [
  `This comprehensive guide covers everything you need to know about ${title.toLowerCase()}, including key features, implementation strategies, and best practices for success. We've compiled detailed information and expert recommendations to help you make informed decisions about your tools and workflows.`,
  `Whether you're just getting started with your first implementation or looking to optimize your existing setup, you'll find valuable insights throughout this resource. Our research-backed approach ensures you have access to accurate, reliable information that can guide your decision-making process effectively, helping you choose the right solutions for your specific needs and business objectives.`
];

// Key Benefits content - still rendered as list items (does not support video blocks)
const keyBenefitsHtml = content.keyBenefits
  ? content.keyBenefits.filter(item => typeof item === 'string').map(b => `<li>${b}</li>`).join('\n')
  : `<li>Comprehensive coverage of ${title.toLowerCase()}</li>
     <li>Up-to-date information and best practices</li>
     <li>Practical examples and use cases</li>
     <li>Expert recommendations and insights</li>`;

// Why Choose content - now supports ContentItem[] (strings or video blocks)
const whyChooseItems: ContentItem[] = content.whyChoose || [
  `When evaluating options for ${title.toLowerCase()}, it's important to consider various factors including functionality, scalability, ease of use, and long-term value. The right choice will integrate seamlessly with your existing tools and processes, whether you're using project management software, email marketing platforms, or other business systems. Strong integration capabilities ensure your tools work together harmoniously.`,
  `Modern businesses benefit from connected ecosystems where CRM software, project management tools, and email marketing platforms share data and insights. This integration enables better decision-making, improved team collaboration, and more effective customer engagement strategies across all touchpoints.`
];
---

<BaseLayout
  title={title}
  description={description}
  ogImage={ogImage}
  locale={locale}
  hreflangLinks={hreflangLinks}
  alternateUrls={alternateUrls}
>
  <nav>
    <a href={base}>Home</a>
    {breadcrumbs.slice(0, -1).map((crumb) => (
      <>
        {' → '}
        <a href={crumb.url}>{crumb.title}</a>
      </>
    ))}
  </nav>

  <h1>{title}</h1>
  <p style="font-size: 1.1rem; line-height: 1.6;">{description}</p>

  {heroImage && <HeroImage image={heroImage} />}

  <section style="margin: 2rem 0;">
    <h2>Overview</h2>
    <ContentRenderer items={overviewItems} linkContext={linkContext} />
  </section>

  {childItems.length > 0 && (
    <section style="margin: 2rem 0;">
      <h2>Explore {title} Topics</h2>
      <p style="margin-bottom: 1.5rem;">Dive deeper into specific aspects of {title.toLowerCase()} with our detailed guides below:</p>

      <div>
        {childItems.map((item) => (
          <article style="margin-bottom: 2rem; padding: 1.5rem; background: #f9f9f9; border-left: 4px solid #333;">
            <h3 style="margin-top: 0;">
              <a href={item.url} style="text-decoration: none; color: #0066cc;">
                {item.title}
              </a>
            </h3>
            <p style="margin: 0.75rem 0 0 0; color: #555; line-height: 1.6;">
              {item.description}
            </p>
            <p style="margin: 0.75rem 0 0 0;">
              <a href={item.url} style="color: #0066cc;">
                Learn more about {item.title.toLowerCase()} →
              </a>
            </p>
          </article>
        ))}
      </div>
    </section>
  )}

  {relatedItems.length > 0 && (
    <section style="margin: 2rem 0; padding: 1.5rem; background: #e8f4f8; border-radius: 8px;">
      <h2>Related Topics</h2>
      <p style="margin-bottom: 1rem;">You might also be interested in these related categories:</p>
      <ul style="line-height: 1.8;">
        {relatedItems.map((item) => (
          <li>
            <a href={item.url} style="color: #0066cc;">
              {item.title}
            </a>
            {' - '}
            {item.description}
          </li>
        ))}
      </ul>
    </section>
  )}

  <section style="margin: 2rem 0;">
    <h2>Key Benefits</h2>
    <ul style="line-height: 1.8;">
      <Fragment set:html={keyBenefitsHtml} />
    </ul>
  </section>

  <section style="margin: 2rem 0;">
    <h2>Why Choose {title}?</h2>
    <ContentRenderer items={whyChooseItems} linkContext={linkContext} />
  </section>

  <hr />
  {breadcrumbs.length > 1 ? (
    <a href={breadcrumbs[breadcrumbs.length - 2].url}>
      ← Back to {breadcrumbs[breadcrumbs.length - 2].title}
    </a>
  ) : (
    <a href={base}>← Back to Home</a>
  )}
</BaseLayout>
